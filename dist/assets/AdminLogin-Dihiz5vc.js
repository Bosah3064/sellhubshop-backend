import{r as o,v as Y,u as $,b5 as V,aw as G,j as e,b as H,x as K,f as x,y as U,a8 as J,d as Q,b3 as p,e as X,b0 as C,b1 as L,ah as Z,ai as ee,aj as E,b4 as se,F as v,ak as F,o as b,I as A,aB as T,B as w,L as ae,q as D,av as te,a0 as re,s as u}from"./index-DIxCcwTo.js";import{S as ie}from"./separator-DYUwGkHk.js";import{E as le}from"./eye-off-BjvTbt_r.js";import{E as ne}from"./eye-DkAcDlvf.js";function ue(){const[r,S]=o.useState(""),[k,M]=o.useState(""),[y,R]=o.useState(!1),[I,P]=o.useState("password"),[l,n]=o.useState(!1),[h,q]=o.useState(""),[s,O]=o.useState(null),z=Y(),{toast:a}=$(),d=V.getInstance();G.useEffect(()=>{(async()=>{try{const t=await(await fetch("https://api.ipify.org?format=json")).json();q(t.ip);const c=d.isIPAllowed(t.ip);O({ip:t.ip,allowed:c.allowed,reason:c.reason,timestamp:new Date().toISOString()}),c.allowed||(console.warn(`Admin Access Restricted: Your Public IP is ${t.ip}. To allow this IP, add it to VITE_ADMIN_ALLOWED_IPS in your .env file.`),a({variant:"destructive",title:"Access Restricted",description:`Your IP address (${t.ip}) is not authorized for admin access.`}))}catch(m){console.error("Error getting IP:",m)}})()},[]);const _=async i=>{i.preventDefault(),n(!0);try{if(await d.isAccountLocked(r)){a({variant:"destructive",title:"Account Locked",description:"This account has been temporarily locked due to multiple failed login attempts."}),n(!1);return}if(s&&!s.allowed){a({variant:"destructive",title:"Access Denied",description:s.reason||"Your IP address is not authorized."}),n(!1);return}if(I==="password"){const{data:t,error:c}=await u.auth.signInWithPassword({email:r,password:k});if(c){await d.trackLoginAttempt(r,h,!1),c.message.includes("Invalid login credentials")?a({variant:"destructive",title:"Login Failed",description:"Invalid email or password. Please try again."}):a({variant:"destructive",title:"Authentication Error",description:c.message||"Failed to authenticate. Please try again."}),n(!1);return}await d.trackLoginAttempt(r,h,!0);const{data:g,error:B}=await u.from("admin_users").select("*").eq("user_id",t.user.id).eq("is_active",!0).single(),ce=g;if(B||!g){await u.auth.signOut(),a({variant:"destructive",title:"Access Denied",description:"You don't have administrator privileges for this panel."}),n(!1);return}const j=d.generateSessionToken(),f=new Date(Date.now()+7200*1e3);try{await u.from("admin_sessions").insert({admin_id:g.id,session_token:j,ip_address:h,user_agent:navigator.userAgent,expires_at:f.toISOString(),two_factor_verified:!1}),localStorage.setItem("admin_session_token",j),localStorage.setItem("admin_session_expiry",f.toISOString())}catch(N){if(N.message?.includes("Two-factor authentication required")||N.code==="P0001")console.log("Admin session creation deferred: 2FA required. Security Gate will handle verification."),localStorage.setItem("admin_session_token",j),localStorage.setItem("admin_session_expiry",f.toISOString());else throw N}await d.logSecurityEvent(g.id,r,"admin_login_success","low",{method:"password",ip:h,role:g.role}),a({title:"Welcome, Admin",description:"Successfully logged into admin panel."}),z("/admin")}else if(I==="magic_link"){const{error:t}=await u.auth.signInWithOtp({email:r,options:{emailRedirectTo:`${window.location.origin}/auth/callback?type=admin`}});if(t){a({variant:"destructive",title:"Error",description:t.message||"Failed to send magic link."}),n(!1);return}a({title:"Magic Link Sent",description:"Check your email for the login link."})}}catch(m){console.error("Admin login error:",m),a({variant:"destructive",title:"Login Failed",description:m.message||"An unexpected error occurred."})}finally{n(!1)}},W=()=>{a({title:"Emergency Access",description:"Please contact the system administrator for emergency access codes.",variant:"destructive"})};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-gray-900 p-4",children:e.jsxs(H,{className:"w-full max-w-md bg-gray-800 border-gray-700",children:[e.jsxs(K,{className:"text-center",children:[e.jsx("div",{className:"mx-auto w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center mb-4",children:e.jsx(x,{className:"h-10 w-10 text-white"})}),e.jsx(U,{className:"text-2xl text-white",children:"Admin Security Portal"}),e.jsx(J,{className:"text-gray-400 mt-2",children:"Restricted access to authorized administrators only"}),s&&e.jsxs("div",{className:"mt-4",children:[e.jsx(Q,{variant:s.allowed?"default":"destructive",className:"flex items-center gap-2",children:s.allowed?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"h-3 w-3"}),"IP Authorized"]}):e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"h-3 w-3"}),"IP Restricted"]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.ip})]})]}),e.jsxs(X,{children:[e.jsx(C,{className:"mb-6 bg-blue-900/20 border-blue-800",children:e.jsxs(L,{className:"text-blue-200 text-sm",children:[e.jsxs("strong",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-4 w-4"}),"Warning:"]}),"Unauthorized access to this system is strictly prohibited and monitored. All activities are logged and recorded."]})}),e.jsxs(Z,{defaultValue:"password",className:"w-full",children:[e.jsxs(ee,{className:"grid w-full grid-cols-2 bg-gray-900",children:[e.jsxs(E,{value:"password",onClick:()=>P("password"),className:"data-[state=active]:bg-gray-700",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Password"]}),e.jsxs(E,{value:"magic",onClick:()=>P("magic_link"),className:"data-[state=active]:bg-gray-700",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Magic Link"]})]}),e.jsx(F,{value:"password",className:"space-y-4 mt-4",children:e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"admin-email",className:"flex items-center gap-2 text-gray-300",children:[e.jsx(v,{className:"h-4 w-4"}),"Admin Email"]}),e.jsx(A,{id:"admin-email",type:"email",placeholder:"admin@example.com",value:r,onChange:i=>S(i.target.value),required:!0,disabled:l,className:"bg-gray-900 border-gray-700 text-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"admin-password",className:"flex items-center gap-2 text-gray-300",children:[e.jsx(T,{className:"h-4 w-4"}),"Password"]}),e.jsxs("div",{className:"relative",children:[e.jsx(A,{id:"admin-password",type:y?"text":"password",placeholder:"••••••••",value:k,onChange:i=>M(i.target.value),required:!0,disabled:l,className:"bg-gray-900 border-gray-700 text-white pr-10"}),e.jsx(w,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>R(!y),children:y?e.jsx(le,{className:"h-4 w-4 text-gray-400"}):e.jsx(ne,{className:"h-4 w-4 text-gray-400"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(ae,{to:"/reset-password",className:"text-xs text-blue-400 hover:text-blue-300",children:"Forgot password?"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Min. 12 characters"})]})]}),e.jsx(w,{type:"submit",className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700",disabled:l||s&&!s.allowed,children:l?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"h-4 w-4 animate-spin mr-2"}),"Authenticating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"h-4 w-4 mr-2"}),"Access Admin Panel"]})})]})}),e.jsx(F,{value:"magic",className:"space-y-4 mt-4",children:e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"magic-email",className:"text-gray-300",children:"Email Address"}),e.jsx(A,{id:"magic-email",type:"email",placeholder:"admin@example.com",value:r,onChange:i=>S(i.target.value),required:!0,disabled:l,className:"bg-gray-900 border-gray-700 text-white"}),e.jsx("p",{className:"text-xs text-gray-500",children:"We'll send you a secure login link"})]}),e.jsx(w,{type:"submit",className:"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700",disabled:l||s&&!s.allowed,children:l?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"h-4 w-4 animate-spin mr-2"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Send Magic Link"]})})]})})]}),e.jsx(ie,{className:"my-6 bg-gray-700"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(C,{className:"bg-gray-900/50 border-gray-700",children:e.jsxs(L,{className:"text-gray-400 text-xs",children:[e.jsx("strong",{children:"Security Features:"}),e.jsxs("ul",{className:"mt-2 space-y-1",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-3 w-3 text-green-400"}),"IP Address Restriction"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-3 w-3 text-green-400"}),"Two-Factor Authentication"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-3 w-3 text-green-400"}),"Session Timeout (2 hours)"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-3 w-3 text-green-400"}),"Real-time Monitoring"]})]})]})}),e.jsx("div",{className:"text-center",children:e.jsxs(w,{variant:"outline",size:"sm",className:"border-red-700 text-red-400 hover:bg-red-900/20 hover:text-red-300",onClick:W,children:[e.jsx(p,{className:"h-3 w-3 mr-2"}),"Emergency Access"]})})]})]}),e.jsx(re,{className:"border-t border-gray-700 pt-6",children:e.jsxs("p",{className:"text-xs text-gray-500 text-center w-full",children:["By accessing this system, you agree to comply with all security policies and procedures.",e.jsx("br",{}),"All login attempts are monitored and recorded for security purposes.",e.jsx("br",{}),"© ",new Date().getFullYear()," Admin Security Portal"]})})]})})}export{ue as default};
