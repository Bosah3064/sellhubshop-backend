import{u as k,v as A,r as h,aw as I,s as n,j as e,b as M,x as U,aB as _,y as F,e as D,o as u,F as T,I as p,B as y,L as B}from"./index-DIxCcwTo.js";import{a as b,t as N,o as j,s as x}from"./types-BUNQPvk4.js";import{A as O}from"./arrow-left-Bbz-V8UC.js";const W=j({email:x().email("Please enter a valid email address")}),Y=j({password:x().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Must contain at least one uppercase letter").regex(/[a-z]/,"Must contain at least one lowercase letter").regex(/[0-9]/,"Must contain at least one number").regex(/[^A-Za-z0-9]/,"Must contain at least one special character"),confirmPassword:x()}).refine(a=>a.password===a.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]});function G(){const{toast:a}=k(),v=A(),[d,m]=h.useState("email"),[P,w]=h.useState(""),[l,c]=h.useState(!1),{register:S,handleSubmit:E,formState:{errors:f}}=b({resolver:N(W)}),{register:g,handleSubmit:R,formState:{errors:t},watch:$}=b({resolver:N(Y)});I.useEffect(()=>{(async()=>{const{data:{session:s}}=await n.auth.getSession(),o=window.location.hash.includes("type=recovery")||window.location.search.includes("type=recovery");(s||o)&&(console.log("Recovery state detected (Session or URL), switching to reset step."),m("reset"),s?.user?.email&&w(s.user.email))})();const{data:{subscription:r}}=n.auth.onAuthStateChange(async(s,o)=>{console.log("Auth event in ResetPassword:",s),(s==="PASSWORD_RECOVERY"||s==="SIGNED_IN")&&(window.location.hash.includes("type=recovery")||s==="PASSWORD_RECOVERY")&&(console.log("Password recovery event matched."),m("reset"),w(o?.user?.email||""))});return()=>{r.unsubscribe()}},[]);const C=async i=>{c(!0);try{const{error:r}=await n.auth.resetPasswordForEmail(i.email,{redirectTo:`${window.location.origin}/reset-password`});if(r)throw r;w(i.email),m("reset"),a({title:"Check your email",description:"We've sent a password reset link to your email address."})}catch(r){console.error("Password reset error:",r);const s=r instanceof Error?r.message:"Unable to send reset email";a({variant:"destructive",title:"Reset failed",description:s})}finally{c(!1)}},L=async i=>{c(!0);try{const{error:r}=await n.auth.updateUser({password:i.password});if(r)throw r;try{const s={id:crypto.randomUUID(),action_type:"password_reset",resource_type:"auth",details:{email:P||"unknown"}};console.log("Password Reset Log Payload:",s);const{error:o}=await n.from("admin_actions").insert(s);o&&console.error("Error logging password reset:",o)}catch(s){console.warn("Audit log failed during password reset:",s)}a({title:"Password updated!",description:"Your password has been successfully reset."}),v("/signin")}catch(r){console.error("Password update error:",r);const s=r instanceof Error?r.message:"Unable to reset password";a({variant:"destructive",title:"Reset failed",description:s})}finally{c(!1)}};return e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-orange-50 to-red-100 p-4",children:e.jsxs(M,{className:"w-full max-w-md shadow-xl border-0",children:[e.jsxs(U,{className:"space-y-1 text-center pb-2",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx(_,{className:"h-12 w-12 text-orange-600"})}),e.jsx(F,{className:"text-2xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent",children:d==="email"?"Reset Password":"Create New Password"}),e.jsx("p",{className:"text-sm text-gray-600",children:d==="email"?"Enter your email to receive a reset link":"Enter your new password below"})]}),e.jsxs(D,{className:"space-y-6",children:[d==="email"?e.jsxs("form",{onSubmit:E(C),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"email",className:"text-sm font-medium",children:"Email Address"}),e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(p,{id:"email",type:"email",placeholder:"you@example.com",...S("email"),className:"h-11 pl-10"})]}),f.email&&e.jsx("p",{className:"text-sm text-red-600",children:f.email.message})]}),e.jsx(y,{type:"submit",className:"w-full h-11 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-semibold",disabled:l,children:l?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Sending..."]}):"Send Reset Link"})]}):e.jsxs("form",{onSubmit:R(L),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"password",className:"text-sm font-medium",children:"New Password"}),e.jsx(p,{id:"password",type:"password",placeholder:"••••••••",...g("password"),className:`h-11 ${t.password?"border-red-500":""}`}),t.password&&e.jsx("p",{className:"text-sm text-red-600",children:t.password.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"confirmPassword",className:"text-sm font-medium",children:"Confirm New Password"}),e.jsx(p,{id:"confirmPassword",type:"password",placeholder:"••••••••",...g("confirmPassword"),className:`h-11 ${t.confirmPassword?"border-red-500":""}`}),t.confirmPassword&&e.jsx("p",{className:"text-sm text-red-600",children:t.confirmPassword.message})]}),e.jsx(y,{type:"submit",className:"w-full h-11 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-semibold",disabled:l,children:l?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Resetting..."]}):"Reset Password"})]}),e.jsx("div",{className:"text-center",children:e.jsxs(B,{to:"/signin",className:"inline-flex items-center text-sm text-blue-600 hover:underline font-medium",children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),"Back to Sign In"]})})]})]})})}export{G as default};
