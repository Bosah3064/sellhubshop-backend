import{c as Q,r as i,s as h,al as b,j as e,q,D as Ue,B as x,d as F,am as Te,an as De,a7 as de,b as ce,ao as Le,ap as qe,aq as me,ar as $e,a3 as ze,a1 as V,P as xe,aa as Ae,ab as Oe,ad as Re,ae as $,as as Ie,af as Fe,f as he,I as ue,e as Ve,A as Be}from"./index-DIxCcwTo.js";import{A as B,a as H,b as K}from"./avatar-C_jNKov4.js";import{S as ge}from"./scroll-area-C5w8SCdh.js";import{M as P}from"./message-circle-C61Fvmn6.js";import{P as W}from"./package-GtKN0b3_.js";import{V as He}from"./video-BUh911uE.js";import{E as Ke}from"./ellipsis-vertical-BUWmQ5u3.js";import{F as We}from"./flag-CVw0EwOT.js";import{I as Je}from"./image-DUKzMe2-.js";import{S as Qe}from"./send-TktZal_A.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=Q("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=Q("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=Q("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);function cs(){const[N,z]=i.useState([]),[c,G]=i.useState(null),[j,f]=i.useState([]),[p,X]=i.useState(""),[U,Y]=i.useState(""),[k,y]=i.useState(!0),[fe,A]=i.useState(!1),[v,Z]=i.useState(!1),[m,pe]=i.useState(null),[_,we]=i.useState(null),[Ye,w]=i.useState(null),[O,ee]=i.useState(!0),[je,be]=i.useState(!1),[S,Ne]=i.useState(!1),[ye,E]=i.useState(!0),se=i.useRef(null),M=i.useRef(null),R=i.useRef(null);i.useEffect(()=>{console.log("Current User ID:",m),console.log("Selected Conversation:",c),console.log("Messages count:",j.length),console.log("Conversations count:",N.length),console.log("Current User Profile:",_)},[m,c,j,N,_]),i.useEffect(()=>{const s=()=>{Ne(window.innerWidth<1024),window.innerWidth<1024&&c&&E(!1)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[c]);const I=i.useCallback(async()=>{try{console.log("Initializing user...");const{data:{user:s},error:r}=await h.auth.getUser();if(r)throw console.error("Auth error:",r),new Error("Failed to authenticate user");if(s){console.log("User found:",s.id),pe(s.id);const{data:t,error:a}=await h.from("profiles").select("*").eq("id",s.id).single();a?console.error("Profile error:",a):we(t),await Promise.all([T(s.id),_e(s.id)])}else console.log("No user found"),w("Please sign in to view messages"),y(!1)}catch(s){console.error("Error initializing user:",s),w("Failed to load messages"),y(!1)}},[]),T=async s=>{try{y(!0),w(null),console.log("Loading conversations for user:",s);const{data:r,error:t}=await h.from("conversations").select(`
          *,
          products (*)
        `).or(`user1_id.eq.${s},user2_id.eq.${s}`).order("updated_at",{ascending:!1});if(t)throw console.error("Conversations query error:",t),t;if(console.log("Raw conversations data:",r),!r?.length){z([]),y(!1);return}const a=await Promise.all(r.map(async n=>{try{const d=n.user1_id===s?n.user2_id:n.user1_id;console.log(`Processing conversation ${n.id}, other user:`,d);const{data:u,error:g}=await h.from("profiles").select("*").eq("id",d).single();g&&console.error(`Error fetching profile for ${d}:`,g);const{data:l,error:C}=await h.from("messages").select("*").eq("conversation_id",n.id).order("created_at",{ascending:!1}).limit(1).single();C&&C.code!=="PGRST116"&&console.error(`Error fetching last message for ${n.id}:`,C);const{count:L,error:oe}=await h.from("messages").select("*",{count:"exact",head:!0}).eq("conversation_id",n.id).eq("is_read",!1).neq("sender_id",s);return oe&&console.error(`Error counting unread messages for ${n.id}:`,oe),{...n,other_user:u||void 0,product:n.products,product_image:n.products?.images?.[0]||null,unread_count:L||0,last_message:l||void 0,last_message_display:l?.content?.substring(0,50)+(l?.content?.length>50?"...":"")||"Start a conversation"}}catch(d){console.error(`Error processing conversation ${n.id}:`,d);const u=n.user1_id===s?n.user2_id:n.user1_id;return{...n,other_user:{id:u,username:"Unknown User"},product:n.products,product_image:n.products?.images?.[0]||null,unread_count:0,last_message:void 0,last_message_display:"Error loading conversation"}}}));console.log("Enhanced conversations:",a),z(a)}catch(r){console.error("Error loading conversations:",r),w("Failed to load conversations"),b.error("Failed to load conversations")}finally{y(!1)}},re=async s=>{if(!m||!s){console.error("Missing currentUserId or conversationId");return}try{A(!0),w(null),console.log("Loading messages for conversation:",s),f([]);const{data:r,error:t}=await h.from("messages").select("*").eq("conversation_id",s).order("created_at",{ascending:!0});if(t)throw console.error("Messages query error:",t),t;if(console.log("Raw messages data:",r),!r?.length){f([]),A(!1);return}const a=Array.from(new Set(r.flatMap(l=>[l.sender_id,l.receiver_id]))).filter(Boolean);console.log("User IDs to fetch:",a);const{data:n,error:d}=await h.from("profiles").select("*").in("id",a);d&&console.error("Profiles fetch error:",d);const u=new Map(n?.map(l=>[l.id,l])||[]);console.log("Profiles map:",u),await ve(s);const g=r.map(l=>{const C=u.get(l.sender_id),L=u.get(l.receiver_id);return console.log(`Message ${l.id}:`,{sender:l.sender_id,receiver:l.receiver_id,senderProfile:C?.full_name,receiverProfile:L?.full_name}),{...l,sender_profile:C,receiver_profile:L,isOwn:l.sender_id===m,status:l.is_read?"read":l.sender_id===m?"sent":"delivered",displayTime:D(l.created_at)}});console.log("Enhanced messages:",g),f(g)}catch(r){console.error("Error loading messages:",r),w("Failed to load messages"),b.error("Failed to load messages")}finally{A(!1)}},ve=async s=>{if(!(!m||!s))try{const{error:r}=await h.from("messages").update({is_read:!0}).eq("conversation_id",s).eq("receiver_id",m).eq("is_read",!1);if(r)throw r;z(t=>t.map(a=>a.id===s?{...a,unread_count:0}:a)),window.dispatchEvent(new CustomEvent("refreshUnreadCounts"))}catch(r){console.error("Error marking messages as read:",r)}},_e=i.useCallback(s=>{try{console.log("Setting up real-time subscription for user:",s);const r=h.channel(`messages-${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},async t=>{const a=t.new;if(!(a.receiver_id!==s&&a.sender_id!==s)){if(console.log("New message received:",a),c&&a.conversation_id===c)try{const{data:n,error:d}=await h.from("profiles").select("*").eq("id",a.sender_id).single();if(d){console.error("Error fetching sender profile:",d);return}const u={...a,sender_profile:n||void 0,receiver_profile:_||void 0,isOwn:a.sender_id===s,status:a.is_read?"read":"delivered",displayTime:D(a.created_at)};f(g=>g.some(l=>l.id===a.id)?g:[...g,u]),setTimeout(()=>{se.current?.scrollIntoView({behavior:"smooth"})},100)}catch(n){console.error("Error processing new message:",n)}T(s)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},t=>{const a=t.new;f(n=>n.map(d=>d.id===a.id?{...d,...a,status:a.is_read?"read":d.status}:d))}).subscribe(t=>{console.log("Realtime subscription status:",t)});return()=>{console.log("Unsubscribing from real-time"),r.unsubscribe()}}catch(r){console.error("Error setting up real-time subscription:",r)}},[c,_,m]),Se=s=>{console.log("Selecting conversation:",s),G(s),f([]),w(null),re(s),S&&E(!1),setTimeout(()=>R.current?.focus(),100)},Ce=()=>{E(!0),G(null)},ae=async()=>{if(!p.trim()||!c||!m){b.error("Please enter a message");return}const s=N.find(r=>r.id===c);if(!s){b.error("Conversation not found");return}try{Z(!0),w(null);const r=s.user1_id===m?s.user2_id:s.user1_id;console.log("Sending message:",{conversationId:c,senderId:m,receiverId:r,content:p.trim(),productId:s.product_id});const t={id:`temp-${Date.now()}`,conversation_id:c,sender_id:m,receiver_id:r,content:p.trim(),message_text:p.trim(),message_type:"text",is_read:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),product_id:s.product_id,sender_profile:_||void 0,receiver_profile:s.other_user,isOwn:!0,status:"sending",displayTime:"Just now"};f(u=>[...u,t]),X("");const{data:a,error:n}=await h.from("messages").insert({conversation_id:c,sender_id:m,receiver_id:r,content:p.trim(),message_text:p.trim(),message_type:"text",is_read:!1,product_id:s.product_id}).select().single();if(n)throw console.error("Send message error:",n),n;console.log("Message sent successfully:",a),await h.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",c);const d={...a,sender_profile:_||void 0,receiver_profile:s.other_user,isOwn:!0,status:"sent",displayTime:D(a.created_at)};f(u=>u.map(g=>g.id===t.id?d:g)),await T(m),b.success("Message sent"),window.dispatchEvent(new CustomEvent("refreshUnreadCounts"))}catch(r){console.error("Error sending message:",r),w("Failed to send message"),b.error("Failed to send message"),f(t=>t.filter(a=>!a.id.startsWith("temp-")))}finally{Z(!1)}},ke=async()=>{m&&(y(!0),await T(m),c&&await re(c),b.success("Refreshed"))},Ee=()=>{const s=!O;ee(s),localStorage.setItem("messageSoundEnabled",JSON.stringify(s)),b.success(`Sound ${s?"enabled":"disabled"}`)},D=s=>{try{const r=new Date(s),a=new Date().getTime()-r.getTime();return a<6e4?"Just now":a<36e5?`${Math.floor(a/6e4)}m ago`:a<864e5?r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):a<6048e5?r.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit"}):r.toLocaleDateString()}catch{return"Unknown time"}},Me=s=>{switch(s){case"sending":return e.jsx(q,{className:"w-3 h-3 animate-spin text-muted-foreground"});case"sent":return e.jsx(J,{className:"w-3 h-3 text-muted-foreground"});case"delivered":return e.jsx(J,{className:"w-3 h-3 text-blue-500"});case"read":return e.jsx(J,{className:"w-3 h-3 text-green-500"});default:return null}},Pe=s=>{const{scrollTop:r,scrollHeight:t,clientHeight:a}=s.currentTarget;be(t-r-a>200)},te=()=>{M.current?.scrollTo({top:M.current.scrollHeight,behavior:"smooth"})};i.useEffect(()=>{if(M.current&&j.length>0){const{scrollTop:s,scrollHeight:r,clientHeight:t}=M.current;r-s-t<300&&te()}},[j]),i.useEffect(()=>{I();const s=localStorage.getItem("messageSoundEnabled");return s!==null&&ee(JSON.parse(s)),()=>{console.log("Cleaning up messages component"),h.removeAllChannels()}},[I]);const ne=N.filter(s=>{if(!U.trim())return!0;const r=U.toLowerCase();return s.other_user?.full_name?.toLowerCase().includes(r)||s.other_user?.username?.toLowerCase().includes(r)||s.product?.name?.toLowerCase().includes(r)||s.last_message_display.toLowerCase().includes(r)}),o=N.find(s=>s.id===c),ie=N.reduce((s,r)=>s+r.unread_count,0),le=()=>e.jsxs(Ve,{className:"p-4 md:p-6 flex flex-col flex-1",children:[e.jsx("div",{className:"mb-4 md:mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(Be,{className:"absolute left-3 md:left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4 md:w-5 md:h-5"}),e.jsx(ue,{placeholder:"Search conversations...",value:U,onChange:s=>Y(s.target.value),className:"pl-10 md:pl-12 h-11 md:h-12 rounded-xl border-2 bg-white/50 focus:bg-white transition-all text-sm md:text-base",disabled:k})]})}),e.jsx(ge,{className:"flex-1 -mx-2",children:e.jsxs("div",{className:"space-y-2 px-2",children:[ne.map(s=>e.jsx("div",{onClick:()=>Se(s.id),className:`p-3 md:p-4 rounded-xl cursor-pointer transition-all border-2 ${c===s.id?"bg-gradient-to-r from-primary/10 to-blue-100/50 border-primary/30 shadow-md":"border-transparent hover:bg-white/70 hover:border-gray-200 hover:shadow-sm"} group`,children:e.jsxs("div",{className:"flex items-center gap-3 md:gap-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(B,{className:"w-12 h-12 md:w-14 md:h-14 border-2 md:border-3 border-white shadow-md group-hover:scale-105 transition-transform",children:[e.jsx(H,{src:s.other_user?.avatar_url,className:"object-cover"}),e.jsx(K,{className:"bg-gradient-to-br from-primary/20 to-blue-100 font-semibold text-xs md:text-sm",children:s.other_user?.full_name?.charAt(0)||s.other_user?.username?.charAt(0)||e.jsx(V,{className:"w-4 h-4 md:w-6 md:h-6"})})]}),s.unread_count>0&&e.jsx(F,{variant:"destructive",className:"absolute -top-1 -right-1 min-w-5 h-5 md:min-w-6 md:h-6 flex items-center justify-center rounded-full text-xs font-bold shadow-md animate-pulse",children:s.unread_count})]}),e.jsxs("div",{className:"flex-1 min-w-0 space-y-1 md:space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-semibold text-gray-900 truncate text-sm",children:s.other_user?.full_name||s.other_user?.username||"Unknown User"}),e.jsx("span",{className:"text-xs text-gray-500 whitespace-nowrap flex-shrink-0 ml-2",children:D(s.updated_at)})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate leading-relaxed",children:s.last_message_display}),s.product&&e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[s.product_image?e.jsx("img",{src:s.product_image,alt:s.product.name,className:"w-6 h-6 rounded object-cover flex-shrink-0 border"}):e.jsx("div",{className:"w-6 h-6 rounded bg-gray-200 flex items-center justify-center flex-shrink-0",children:e.jsx(W,{className:"w-3 h-3 text-gray-500"})}),e.jsx("div",{className:"bg-primary/10 text-primary px-2 py-1 rounded-full font-medium truncate flex-1",children:s.product.name}),e.jsxs("span",{className:"font-bold text-primary whitespace-nowrap",children:["KES ",s.product.price?.toLocaleString()]})]})]})]})},s.id)),ne.length===0&&!k&&e.jsxs("div",{className:"text-center py-8 md:py-12 text-gray-500",children:[e.jsx(P,{className:"w-12 h-12 md:w-16 md:h-16 mx-auto mb-4 opacity-40"}),e.jsx("p",{className:"font-semibold mb-2 text-sm md:text-base",children:"No conversations found"}),U?e.jsx(x,{onClick:()=>Y(""),variant:"outline",size:"sm",className:"rounded-lg",children:"Clear Search"}):e.jsx("p",{className:"text-xs md:text-sm max-w-xs mx-auto",children:"Your conversations will appear here when you start messaging buyers or sellers"})]})]})})]});return k&&N.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(P,{className:"w-12 h-12 md:w-16 md:h-16 text-primary/60 mx-auto mb-4"}),e.jsx(q,{className:"w-6 h-6 animate-spin text-primary absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-900",children:"Loading Messages"}),e.jsx("p",{className:"text-gray-600 text-sm md:text-base max-w-sm",children:"We're loading your conversations. This will just take a moment..."})]})]})}):m?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 safe-area-bottom",children:e.jsxs("div",{className:"container mx-auto px-3 md:px-4 py-4 md:py-8 max-w-7xl",children:[e.jsx("div",{className:"mb-4 md:mb-8",children:e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 md:gap-6",children:[e.jsx("div",{className:"space-y-2 md:space-y-3",children:e.jsxs("div",{className:"flex items-center gap-3 md:gap-4",children:[e.jsx("div",{className:"bg-white rounded-2xl p-2 md:p-3 shadow-sm border",children:e.jsx(P,{className:"w-6 h-6 md:w-8 md:h-8 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-4xl font-bold bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent",children:"Messages"}),e.jsxs("p",{className:"text-gray-600 mt-1 flex items-center gap-2 text-sm md:text-base",children:["Chat with buyers and sellers",ie>0&&e.jsxs(F,{variant:"destructive",className:"animate-pulse text-xs",children:[ie," unread"]})]})]})]})}),e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx(x,{variant:"outline",size:"icon",onClick:Ee,className:"h-10 w-10 md:h-11 md:w-11 rounded-xl border-2",title:O?"Disable sound":"Enable sound",children:O?e.jsx(Te,{className:"w-4 h-4 md:w-5 md:h-5"}):e.jsx(De,{className:"w-4 h-4 md:w-5 md:h-5"})}),e.jsxs(x,{variant:"outline",onClick:ke,disabled:k,className:"h-10 px-3 md:h-11 md:px-4 rounded-xl border-2 flex items-center gap-2 md:gap-3 text-sm",children:[e.jsx(de,{className:`w-4 h-4 ${k?"animate-spin":""}`}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-4 gap-4 md:gap-6 h-[calc(100vh-140px)] md:h-[calc(100vh-200px)]",children:[!S&&e.jsx(ce,{className:"xl:col-span-1 flex flex-col border-0 shadow-lg rounded-2xl bg-white/80 backdrop-blur-sm",children:e.jsx(le,{})}),S&&e.jsxs(Le,{open:ye,onOpenChange:E,children:[e.jsx(qe,{asChild:!0,children:e.jsx(x,{variant:"outline",size:"icon",className:"fixed bottom-4 right-4 z-50 h-12 w-12 rounded-full shadow-lg bg-white",children:e.jsx(me,{className:"w-5 h-5"})})}),e.jsx($e,{side:"left",className:"w-full sm:max-w-md p-0",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Conversations"})}),e.jsx(le,{})]})})]}),e.jsx(ce,{className:`flex flex-col h-full border-0 shadow-lg rounded-2xl bg-white/80 backdrop-blur-sm overflow-hidden ${S?"col-span-1":"xl:col-span-3"}`,children:o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 md:p-6 border-b border-gray-200 bg-white/90 backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 md:gap-4",children:[S&&e.jsx(x,{variant:"ghost",size:"icon",onClick:Ce,className:"h-10 w-10 rounded-xl mr-1",children:e.jsx(ze,{className:"w-5 h-5"})}),e.jsxs(B,{className:"w-10 h-10 md:w-14 md:h-14 border-2 md:border-3 border-white shadow-md",children:[e.jsx(H,{src:o.other_user?.avatar_url}),e.jsx(K,{className:"bg-gradient-to-br from-primary/20 to-blue-100 font-semibold text-xs md:text-sm",children:o.other_user?.full_name?.charAt(0)||o.other_user?.username?.charAt(0)||e.jsx(V,{className:"w-4 h-4 md:w-6 md:h-6"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("h3",{className:"font-bold text-base md:text-lg text-gray-900",children:o.other_user?.full_name||o.other_user?.username||"Unknown User"}),o.unread_count>0&&e.jsx(F,{variant:"destructive",className:"text-xs font-bold animate-pulse",children:o.unread_count})]}),o.product?e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 rounded-lg p-2 border max-w-md",children:[o.product_image?e.jsx("img",{src:o.product_image,alt:o.product.name,className:"w-8 h-8 rounded object-cover flex-shrink-0"}):e.jsx("div",{className:"w-8 h-8 rounded bg-gray-200 flex items-center justify-center flex-shrink-0",children:e.jsx(W,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium text-gray-900 truncate",children:o.product.name}),e.jsxs("p",{className:"text-xs font-bold text-primary",children:["KES ",o.product.price?.toLocaleString()]})]})]}):e.jsx("div",{className:"flex items-center gap-2 md:gap-4 text-xs md:text-sm text-gray-600",children:e.jsx("span",{children:"Direct message"})})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-9 w-9 md:h-11 md:w-11 rounded-xl",title:"Voice call",children:e.jsx(xe,{className:"w-4 h-4 md:w-5 md:h-5"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-9 w-9 md:h-11 md:w-11 rounded-xl",title:"Video call",children:e.jsx(He,{className:"w-4 h-4 md:w-5 md:h-5"})}),e.jsxs(Ae,{children:[e.jsx(Oe,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-9 w-9 md:h-11 md:w-11 rounded-xl",children:e.jsx(Ke,{className:"w-4 h-4 md:w-5 md:h-5"})})}),e.jsxs(Re,{align:"end",className:"w-48 rounded-xl",children:[e.jsxs($,{className:"flex items-center gap-3 rounded-lg text-sm",children:[e.jsx(V,{className:"w-4 h-4"}),"View Profile"]}),o.product&&e.jsxs($,{className:"flex items-center gap-3 rounded-lg text-sm",children:[e.jsx(Ie,{className:"w-4 h-4"}),"View Product"]}),e.jsx(Fe,{}),e.jsxs($,{className:"flex items-center gap-3 rounded-lg text-sm",children:[e.jsx(he,{className:"w-4 h-4"}),"Block User"]}),e.jsxs($,{className:"flex items-center gap-3 rounded-lg text-sm text-destructive",children:[e.jsx(We,{className:"w-4 h-4"}),"Report"]})]})]})]})]})}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0 relative bg-gradient-to-b from-white to-blue-50/30",children:[je&&e.jsxs(x,{variant:"secondary",size:"sm",className:"absolute top-4 md:top-6 left-1/2 transform -translate-x-1/2 z-10 shadow-lg border-2 rounded-full backdrop-blur-sm text-xs",onClick:te,children:[e.jsx(de,{className:"w-3 h-3 md:w-4 md:h-4 mr-2"}),"Scroll to latest"]}),e.jsx(ge,{className:"h-full",ref:M,onScroll:Pe,children:e.jsx("div",{className:"p-4 md:p-6 flex flex-col min-h-full space-y-4 md:space-y-6",children:fe?e.jsxs("div",{className:"flex justify-center items-center py-8 md:py-12",children:[e.jsx(q,{className:"w-6 h-6 md:w-8 md:h-8 animate-spin text-primary mr-2 md:mr-3"}),e.jsx("span",{className:"text-gray-600 font-medium text-sm md:text-base",children:"Loading messages..."})]}):j.length>0?e.jsxs(e.Fragment,{children:[j.map((s,r)=>{const t=r===0||j[r-1]?.sender_id!==s.sender_id||new Date(s.created_at).getTime()-new Date(j[r-1].created_at).getTime()>3e5;return e.jsx("div",{className:`flex ${s.isOwn?"justify-end":"justify-start"} group`,children:e.jsxs("div",{className:`flex items-end gap-2 md:gap-3 max-w-[85%] md:max-w-[75%] ${s.isOwn?"flex-row-reverse":"flex-row"}`,children:[!s.isOwn&&t&&e.jsxs(B,{className:"w-8 h-8 md:w-10 md:h-10 flex-shrink-0 mt-1 border-2 border-white shadow-sm",children:[e.jsx(H,{src:s.sender_profile?.avatar_url}),e.jsx(K,{className:"text-xs bg-gradient-to-br from-gray-100 to-gray-200",children:s.sender_profile?.full_name?.charAt(0)||s.sender_profile?.username?.charAt(0)||"U"})]}),!s.isOwn&&!t&&e.jsx("div",{className:"w-8 md:w-10 flex-shrink-0"}),e.jsxs("div",{className:`flex flex-col ${s.isOwn?"items-end":"items-start"} space-y-1 md:space-y-2 flex-1 min-w-0`,children:[!s.isOwn&&t&&e.jsx("p",{className:"text-xs text-gray-500 font-medium px-2 md:px-3",children:s.sender_profile?.full_name||s.sender_profile?.username||"Unknown User"}),e.jsx("div",{className:`rounded-2xl px-3 py-2 md:px-4 md:py-3 max-w-full shadow-sm ${s.isOwn?"bg-gradient-to-br from-primary to-primary/90 text-white rounded-br-md":"bg-white border border-gray-200 rounded-bl-md"} group-hover:shadow-md transition-shadow`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed",children:s.content})}),e.jsxs("div",{className:`flex items-center gap-1 md:gap-2 px-1 ${s.isOwn?"flex-row-reverse":""}`,children:[e.jsx("span",{className:`text-xs ${s.isOwn?"text-primary/70":"text-gray-500"}`,children:s.displayTime}),s.isOwn&&e.jsx("span",{className:"flex items-center",children:Me(s.status)})]})]})]})},s.id)}),e.jsx("div",{ref:se})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center max-w-md space-y-4 p-4",children:[e.jsx(P,{className:"w-16 h-16 md:w-20 md:h-20 mx-auto opacity-30"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg md:text-xl text-gray-700",children:"No messages yet"}),e.jsxs("p",{className:"text-gray-600 text-sm md:text-base",children:["Start the conversation by sending a message. Be clear and friendly to build trust with"," ",o.other_user?.full_name||"the other user","."]})]}),e.jsx(x,{onClick:()=>R.current?.focus(),variant:"outline",size:"lg",className:"rounded-xl border-2 mt-4 text-sm md:text-base",children:"Write your first message"})]})})})})]}),e.jsx("div",{className:"p-4 md:p-6 border-t border-gray-200 bg-white/90 backdrop-blur-sm safe-area-padding",children:e.jsxs("div",{className:"flex items-center gap-2 md:gap-3 w-full",children:[e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx(x,{variant:"ghost",size:"icon",disabled:v,className:"h-10 w-10 md:h-12 md:w-12 rounded-xl",children:e.jsx(Ge,{className:"w-4 h-4 md:w-5 md:h-5"})}),e.jsx(x,{variant:"ghost",size:"icon",disabled:v,className:"h-10 w-10 md:h-12 md:w-12 rounded-xl",children:e.jsx(Je,{className:"w-4 h-4 md:w-5 md:h-5"})})]}),e.jsxs("div",{className:"flex-1 flex items-center gap-2 md:gap-3 min-w-0 bg-white border-2 border-gray-200 rounded-2xl px-3 md:px-4 focus-within:border-primary focus-within:shadow-sm transition-all",children:[e.jsx(ue,{ref:R,placeholder:`Message ${o.other_user?.full_name||o.other_user?.username||"user"}...`,value:p,onChange:s=>X(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&!v&&p.trim()&&(s.preventDefault(),ae())},className:"flex-1 min-w-0 border-0 focus-visible:ring-0 focus-visible:ring-offset-0 bg-transparent py-2 md:py-3 text-sm md:text-base",disabled:v}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-8 w-8 md:h-10 md:w-10 rounded-xl",children:e.jsx(Xe,{className:"w-4 h-4"})}),e.jsx(x,{onClick:ae,disabled:!p.trim()||v,size:"icon",className:"h-8 w-8 md:h-10 md:w-10 rounded-xl bg-gradient-to-br from-primary to-primary/90 hover:from-primary/90 hover:to-primary transition-all",children:v?e.jsx(q,{className:"w-3 h-3 md:w-4 md:h-4 animate-spin"}):e.jsx(Qe,{className:"w-3 h-3 md:w-4 md:h-4"})})]})]})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center max-w-md space-y-4 md:space-y-6 p-4",children:[e.jsx("div",{className:"bg-gradient-to-br from-primary/10 to-blue-100/50 rounded-3xl p-6 md:p-8 inline-block",children:e.jsx(P,{className:"w-16 h-16 md:w-20 md:h-20 text-primary/50 mx-auto"})}),e.jsxs("div",{className:"space-y-2 md:space-y-3",children:[e.jsx("h3",{className:"font-bold text-xl md:text-2xl text-gray-700",children:"Select a Conversation"}),e.jsx("p",{className:"text-gray-600 text-sm md:text-lg",children:"Choose a conversation from the list to start messaging or view your existing chats"}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"bg-white rounded-lg p-3 border shadow-sm max-w-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded flex items-center justify-center",children:e.jsx(W,{className:"w-5 h-5 text-gray-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-900",children:"Product chats show thumbnails"}),e.jsx("p",{className:"text-xs text-primary font-bold",children:"KES 0"})]})]})})})]}),S&&e.jsxs(x,{onClick:()=>E(!0),className:"rounded-xl",children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"View Conversations"]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 md:gap-4 text-xs md:text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(xe,{className:"w-3 h-3 md:w-4 md:h-4"}),e.jsx("span",{children:"Secure messaging"})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(he,{className:"w-3 h-3 md:w-4 md:h-4"}),e.jsx("span",{children:"Protected"})]})]})]})})})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"text-center space-y-6 max-w-md w-full",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-lg border",children:[e.jsx(Ue,{className:"w-12 h-12 md:w-16 md:h-16 text-amber-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-900 mb-2",children:"Authentication Required"}),e.jsx("p",{className:"text-gray-600 text-sm md:text-base mb-6",children:"Please sign in to access your messages and continue conversations with buyers and sellers."}),e.jsx(x,{onClick:I,size:"lg",className:"w-full",children:"Sign In to Continue"})]})})})}export{cs as default};
