import{c as ce,v as me,a as ue,bo as he,r as a,s as h,j as e,b as O,x as G,y as I,M as pe,a8 as Q,B as x,e as D,ac as $,o as N,I as v,C as xe,al as o}from"./index-DIxCcwTo.js";import{S as fe}from"./separator-DYUwGkHk.js";import{P as ye}from"./plus-CBbazF2H.js";import{C as ge}from"./credit-card-CW0P80aF.js";import{S as X}from"./shield-check-CLmxCABJ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=ce("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);function Ce(){const b=me(),{cart:m,getTotal:w,clearCart:R}=ue(),{user:p}=he(),[f,B]=a.useState(1),[y,Z]=a.useState([]),[n,E]=a.useState(null),[ee,F]=a.useState(!1),[t,d]=a.useState({full_name:"",phone_number:"",region:"Nairobi",city:"",address_details:""}),[j,_]=a.useState(0),[u,K]=a.useState("mpesa"),[M,C]=a.useState(!1),[H,se]=a.useState([]),[W,z]=a.useState([]),[T,re]=a.useState(""),[U,ae]=a.useState(null),[J,S]=a.useState(!1);a.useEffect(()=>{if(m.length===0){b("/cart");return}V(),te(),ie()},[m,b]),a.useEffect(()=>{if(n){const s=y.find(r=>r.id===n);s&&k(s.region)}},[n,U,y]);const te=async()=>{const{data:s,error:r}=await h.from("location_nodes").select("*").eq("type","county").order("name");s&&se(s)},le=async s=>{if(!s||s==="other"){z([]);return}const{data:r,error:l}=await h.from("location_nodes").select("*").eq("parent_id",s).order("name");r&&z(r)},ie=async()=>{if(m.length>0&&m[0].seller_id){console.log("Fetching seller profile for:",m[0].seller_id);const{data:s,error:r}=await h.from("profiles").select("*").eq("id",m[0].seller_id).single();r&&console.error("Error fetching seller profile:",r),s&&(console.log("Seller profile loaded:",s),ae(s))}else console.warn("No seller ID found in cart items")},k=(s,r=U)=>{if(console.log("Calculating delivery fee for region:",s,"Profile:",r),!r){console.warn("Seller profile not loaded yet, using default fallback fees"),_(s==="Nairobi"?200:450);return}const l=r.business_location||"Nairobi",c=Number(r.local_delivery_fee)||200,i=Number(r.outside_delivery_fee)||350;console.log(`Fees - Local: ${c}, Outside: ${i}, Biz Loc: ${l}`),s.toLowerCase().includes(l.toLowerCase())||l.toLowerCase().includes(s.toLowerCase())?(console.log("Applying local delivery fee"),_(c)):(console.log("Applying outside delivery fee"),_(i))},V=async()=>{if(!p)return;const{data:s,error:r}=await h.from("user_addresses").select("*").eq("user_id",p.id).order("is_default",{ascending:!1});if(r)console.error("Error fetching addresses:",r);else{Z(s||[]);const l=s?.find(c=>c.is_default);l&&(E(l.id),k(l.region))}},ne=async s=>{if(s.preventDefault(),!p)return;C(!0);const{data:r,error:l}=await h.from("user_addresses").insert([{user_id:p.id,...t,is_default:y.length===0}]).select();C(!1),l?o.error("Failed to add address: "+l.message):(o.success("Address added successfully"),V(),F(!1),r&&r[0]&&(E(r[0].id),k(r[0].region)))},oe=(s,r)=>{E(s),k(r)},[Y,g]=a.useState("idle");a.useEffect(()=>{let s;return Y==="processing"&&u==="mpesa"&&(s=setInterval(async()=>{},5e3)),()=>clearInterval(s)},[Y,u]);const de=async()=>{if(!(!p||!n)){C(!0),g("processing");try{const{data:s,error:r}=await h.from("marketplace_orders").insert([{buyer_id:p.id,total_amount:w()+j,delivery_address_id:n,delivery_fee:j,payment_method:u,status:"pending"}]).select().single();if(r)throw r;console.log("Order created:",s.id);const l=m.map(i=>({order_id:s.id,product_id:i.id,seller_id:i.seller_id,quantity:i.quantity||1,price_at_purchase:i.price,total_price:i.price*(i.quantity||1)})),{error:c}=await h.from("order_items").insert(l);if(c)throw c;if(u==="mpesa"){o.info("Order placed! Initiating M-Pesa STK Push...");const P=y.find(A=>A.id===n)?.phone_number||"";try{const L=await(await fetch("https://sellhubshop-backend.onrender.com/api/v1/stk-push",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:Math.ceil(w()+j),phone:P,accountRef:s.id,description:`Order #${s.id.substring(0,8)}`,orderId:s.id})})).json();console.log("STK Push Result:",L),L.ResponseCode==="0"?(o.success("STK Push sent! Please check your phone."),setTimeout(()=>{R(),b("/dashboard")},3e3)):(o.error("M-Pesa request failed: "+(L.errorMessage||"Unknown error")),g("failed"))}catch(A){console.error(A),o.error("Failed to contact payment server."),g("failed")}}else{o.info("Processing wallet payment...");const{data:i,error:P}=await h.rpc("pay_order_via_wallet",{p_order_id:s.id,p_buyer_id:p.id});P?(console.error("Wallet Payment Error:",P),o.error("Wallet payment failed. Please try again."),g("failed")):(console.log("Wallet Payment Result:",i),i.success?(o.success("Payment successful! Order completed."),R(),b("/dashboard")):(o.error("Payment failed: "+i.message),g("failed")))}}catch(s){console.error("Order processing error:",s),o.error("Order failed: "+s.message),g("failed")}finally{C(!1)}}},q=y.find(s=>s.id===n);return e.jsx("div",{className:"min-h-screen bg-gray-50 py-12",children:e.jsxs("div",{className:"container mx-auto px-4 max-w-4xl",children:[e.jsx("h1",{className:"text-3xl font-black mb-8",children:"Checkout"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(O,{className:f===1?"border-primary ring-1 ring-primary":"",children:[e.jsxs(G,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-primary"}),"Delivery Address"]}),e.jsx(Q,{children:"Where should we send your items?"})]}),f>1&&e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>B(1),className:"text-primary",children:"Change"})]}),e.jsx(D,{children:f===1?e.jsxs("div",{className:"space-y-4",children:[y.map(s=>e.jsx("div",{onClick:()=>oe(s.id,s.region),className:`p-4 rounded-xl border-2 cursor-pointer transition-all ${n===s.id?"border-primary bg-primary/5 shadow-sm":"border-gray-100 hover:border-gray-200"}`,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:s.full_name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.phone_number}),e.jsxs("p",{className:"text-sm mt-1",children:[s.address_details,", ",s.city]}),e.jsx("p",{className:"text-sm font-medium text-primary uppercase text-[10px] tracking-wider mt-1",children:s.region})]}),n===s.id&&e.jsx("div",{className:"bg-primary text-white p-1 rounded-full",children:e.jsx($,{className:"h-4 w-4"})})]})},s.id)),ee?e.jsxs("form",{onSubmit:ne,className:"space-y-4 p-4 border-2 border-dashed border-gray-200 rounded-xl",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"full_name",children:"Full Name"}),e.jsx(v,{id:"full_name",required:!0,value:t.full_name,onChange:s=>d({...t,full_name:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"phone",children:"Phone Number"}),e.jsx(v,{id:"phone",required:!0,placeholder:"07...",value:t.phone_number,onChange:s=>d({...t,phone_number:s.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"region",children:"County"}),e.jsxs("select",{id:"region",className:"w-full p-2 border rounded-md text-sm",value:T,onChange:s=>{const r=s.target.value;if(re(r),r==="other")d({...t,region:"Other",city:""}),S(!0);else{const l=H.find(c=>c.id===r)?.name||"";d({...t,region:l}),le(r),S(!1)}},children:[e.jsx("option",{value:"",children:"Select County"}),H.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)),e.jsx("option",{value:"other",children:"Other (Type manually)"})]}),T==="other"&&e.jsx(v,{className:"mt-2",placeholder:"Enter County name",onChange:s=>d({...t,region:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"city",children:"City/Area"}),!J&&W.length>0?e.jsxs("select",{id:"city",className:"w-full p-2 border rounded-md text-sm",value:t.city,onChange:s=>{const r=s.target.value;r==="other"?(S(!0),d({...t,city:""})):d({...t,city:r})},children:[e.jsx("option",{value:"",children:"Select City"}),W.map(s=>e.jsx("option",{value:s.name,children:s.name},s.id)),e.jsx("option",{value:"other",children:"Other (Type manually)"})]}):e.jsx(v,{id:"city",required:!0,value:t.city,placeholder:"Enter City/Area name",onChange:s=>d({...t,city:s.target.value})}),J&&T!=="other"&&e.jsx(x,{variant:"ghost",size:"sm",className:"text-[10px] h-6 px-1",onClick:()=>S(!1),children:"Back to list"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"details",children:"Specific Address Details"}),e.jsx(v,{id:"details",required:!0,placeholder:"Building, Floor, Room Number...",value:t.address_details,onChange:s=>d({...t,address_details:s.target.value})})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(x,{type:"button",variant:"ghost",onClick:()=>F(!1),children:"Cancel"}),e.jsx(x,{type:"submit",disabled:M,children:"Save Address"})]})]}):e.jsxs(x,{variant:"outline",className:"w-full border-dashed py-8 h-auto flex flex-col gap-2",onClick:()=>F(!0),children:[e.jsx(ye,{className:"h-6 w-6"}),"Add New Address"]}),e.jsxs(x,{className:"w-full mt-4",disabled:!n,onClick:()=>B(2),children:["Use this address",e.jsx(xe,{className:"h-4 w-4 ml-2"})]})]}):e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-bold",children:q?.full_name}),e.jsxs("p",{className:"text-gray-600",children:[q?.address_details,", ",q?.city]})]})})]}),e.jsxs(O,{className:f===2?"border-primary ring-1 ring-primary":"",children:[e.jsxs(G,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),"Payment Method"]}),e.jsx(Q,{children:"Choose how you want to pay"})]}),e.jsx(D,{children:f>=2&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{onClick:()=>K("mpesa"),className:`p-4 rounded-xl border-2 cursor-pointer transition-all flex items-center gap-4 ${u==="mpesa"?"border-primary bg-primary/5":"border-gray-100 opacity-60 hover:opacity-100"}`,children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center font-bold text-green-700",children:"M"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold",children:"M-Pesa"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Secure mobile payment"})]}),u==="mpesa"&&e.jsx($,{className:"h-5 w-5 text-primary"})]}),e.jsxs("div",{onClick:()=>K("wallet"),className:`p-4 rounded-xl border-2 cursor-pointer transition-all flex items-center gap-4 ${u==="wallet"?"border-primary bg-primary/5":"border-gray-100 opacity-60 hover:opacity-100"}`,children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-700",children:e.jsx(X,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold",children:"SellHub Wallet"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Pay using your earnings"})]}),u==="wallet"&&e.jsx($,{className:"h-5 w-5 text-primary"})]})]})})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(O,{className:"sticky top-24 border-0 shadow-xl overflow-hidden",children:[e.jsx("div",{className:"bg-primary p-4 text-white",children:e.jsx(I,{className:"text-lg",children:"Order Summary"})}),e.jsx(D,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:["Items Total (",m.length,")"]}),e.jsxs("span",{className:"font-bold",children:["KES ",w().toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 group relative",children:[e.jsx("span",{className:"text-gray-600",children:"Delivery Fee"}),e.jsx(je,{className:"h-3 w-3 text-gray-400"})]}),e.jsxs("span",{className:"font-bold",children:["KES ",j.toLocaleString()]})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex justify-between text-lg",children:[e.jsx("span",{className:"font-bold",children:"Total Amount"}),e.jsxs("span",{className:"font-black text-primary",children:["KES ",(w()+j).toLocaleString()]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg flex items-start gap-2 mt-4",children:[e.jsx(X,{className:"h-4 w-4 text-green-600 mt-0.5"}),e.jsx("p",{className:"text-[10px] text-gray-500 leading-tight",children:"Your payment is held securely in escrow until you confirm receipt of your items."})]}),e.jsx(x,{className:"w-full py-6 text-lg font-bold shadow-lg shadow-primary/25 mt-4",disabled:f<2||M||!n,onClick:de,children:M?"Processing...":"Pay Now"})]})})]})})]})]})})}export{Ce as default};
