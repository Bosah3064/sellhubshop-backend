import{r as l,s as n,al as o,j as e,a7 as M,B as m,b as f,e as j,T as ie,A as ce,I as U,x as oe,aU as P,d as de,o as $}from"./index-DIxCcwTo.js";import{A as R,a as I,b as q}from"./avatar-C_jNKov4.js";import{D as H,a as z,d as O,c as K,e as me,f as xe}from"./dialog-YYEI7PMn.js";import{T as he}from"./textarea-QQPFZBv8.js";import{U as ue}from"./users-DBPXf3v8.js";import{D as ge}from"./dollar-sign-CKhvHsyU.js";import{A as fe}from"./activity-B3fA73-G.js";import{P as je}from"./plus-CBbazF2H.js";import{M as pe}from"./minus-D2mlxTIY.js";import{E as ve}from"./eye-DkAcDlvf.js";import{A as Ne}from"./arrow-down-left-DGEwyqp5.js";import{A as be}from"./arrow-up-right-7gsiyfAW.js";import{f as V}from"./format-CcXPetpd.js";function Ue(){const[w,G]=l.useState([]),[C,y]=l.useState([]),[d,J]=l.useState(""),[Q,S]=l.useState(!0),[a,A]=l.useState(null),[X,Y]=l.useState([]),[we,ye]=l.useState(!1),[Z,W]=l.useState(!1),[ee,p]=l.useState(!1),[i,se]=l.useState("credit"),[x,D]=l.useState(""),[h,T]=l.useState(""),[k,E]=l.useState(!1),[v,te]=l.useState({totalWallets:0,totalBalance:0,activeWallets:0,todayTransactions:0});l.useEffect(()=>{u();const s=n.channel("admin-wallets-changes").on("postgres_changes",{event:"*",schema:"public",table:"wallets"},r=>{console.log("Wallet update received:",r),u()}).subscribe(),t=n.channel("admin-transactions-changes").on("postgres_changes",{event:"*",schema:"public",table:"wallet_transactions"},r=>{console.log("Transaction update received:",r),u()}).subscribe();return()=>{n.removeChannel(s),n.removeChannel(t)}},[]);const u=async()=>{S(!0);try{const{data:s,error:t}=await n.from("wallets").select(`
          *,
          profiles:user_id (
            email,
            full_name,
            avatar_url
          )
        `).order("balance",{ascending:!1});if(t)throw t;const r=await Promise.all((s||[]).map(async c=>{const{count:_}=await n.from("wallet_transactions").select("*",{count:"exact",head:!0}).eq("wallet_id",c.id),{data:ne}=await n.from("wallet_transactions").select("created_at").eq("wallet_id",c.id).order("created_at",{ascending:!1}).limit(1).single();return{...c,user_email:c.profiles?.email,user_name:c.profiles?.full_name,user_avatar:c.profiles?.avatar_url,transaction_count:_||0,last_activity:ne?.created_at}}));G(r),y(r);const N=r.reduce((c,_)=>c+_.balance,0),b=r.filter(c=>(c.transaction_count||0)>0).length,g=new Date;g.setHours(0,0,0,0);const{count:le}=await n.from("wallet_transactions").select("*",{count:"exact",head:!0}).gte("created_at",g.toISOString());te({totalWallets:r.length,totalBalance:N,activeWallets:b,todayTransactions:le||0})}catch(s){console.error("Error fetching wallets:",s),o.error("Failed to load wallets")}finally{S(!1)}};l.useEffect(()=>{if(d.trim()==="")y(w);else{const s=w.filter(t=>t.user_email?.toLowerCase().includes(d.toLowerCase())||t.user_name?.toLowerCase().includes(d.toLowerCase())||t.balance.toString().includes(d));y(s)}},[d,w]);const ae=async s=>{try{const{data:t,error:r}=await n.from("wallet_transactions").select("*").eq("wallet_id",s).order("created_at",{ascending:!1}).limit(50);if(r)throw r;Y(t||[])}catch(t){console.error("Error fetching transactions:",t),o.error("Failed to load transactions")}},L=async s=>{A(s),await ae(s.id),W(!0)},F=(s,t)=>{A(s),se(t),D(""),T(""),p(!0)},re=async()=>{if(!a||!x||!h){o.error("Please fill in all fields");return}const s=parseFloat(x);if(isNaN(s)||s<=0){o.error("Please enter a valid amount");return}E(!0);try{const{data:{user:t}}=await n.auth.getUser();if(!t)throw new Error("Admin user not authenticated");const{error:r}=await n.from("wallet_transactions").insert({wallet_id:a.id,amount:s,type:i,reference_type:"admin_adjustment",description:`Admin ${i}: ${h}`,status:"completed"});if(r)throw r;const N=i==="credit"?a.balance+s:a.balance-s,{error:b}=await n.from("wallets").update({balance:N}).eq("id",a.id);if(b)throw b;const{error:g}=await n.from("admin_actions").insert({admin_id:t.id,action_type:`wallet_${i}`,target_type:"wallet",target_id:a.id,details:{user_id:a.user_id,user_email:a.user_email,amount:s,currency:a.currency,previous_balance:a.balance,new_balance:N,reason:h,adjustment_type:i},ip_address:null,user_agent:navigator.userAgent,status:"success"});g&&(console.error("Failed to log admin action:",g),o.error("Warning: Action completed but audit log failed")),o.success(`Wallet ${i}ed successfully`),p(!1),u()}catch(t){console.error("Error adjusting wallet:",t);try{const{data:{user:r}}=await n.auth.getUser();r&&await n.from("admin_actions").insert({admin_id:r.id,action_type:`wallet_${i}_failed`,target_type:"wallet",target_id:a.id,details:{error:t.message,amount:s,reason:h},status:"failed"})}catch(r){console.error("Failed to log error:",r)}o.error("Failed to adjust wallet: "+t.message)}finally{E(!1)}},B=s=>s?s.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2):"?";return Q?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(M,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"container mx-auto px-4 py-8 space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-heading font-black text-gray-900",children:"Wallet Management"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Monitor and manage user wallets"})]}),e.jsxs(m,{onClick:u,variant:"outline",className:"gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),"Refresh"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(f,{className:"glass hover:glass-strong transition-smooth hover-lift border-white/20",children:e.jsx(j,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Wallets"}),e.jsx("h3",{className:"text-3xl font-black mt-2",children:v.totalWallets})]}),e.jsx("div",{className:"p-3 bg-blue-100 rounded-2xl",children:e.jsx(ue,{className:"w-6 h-6 text-blue-600"})})]})})}),e.jsx(f,{className:"glass hover:glass-strong transition-smooth hover-lift border-white/20",children:e.jsx(j,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Balance"}),e.jsxs("h3",{className:"text-3xl font-black mt-2",children:["KES ",v.totalBalance.toLocaleString()]})]}),e.jsx("div",{className:"p-3 bg-green-100 rounded-2xl",children:e.jsx(ge,{className:"w-6 h-6 text-green-600"})})]})})}),e.jsx(f,{className:"glass hover:glass-strong transition-smooth hover-lift border-white/20",children:e.jsx(j,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Active Wallets"}),e.jsx("h3",{className:"text-3xl font-black mt-2",children:v.activeWallets})]}),e.jsx("div",{className:"p-3 bg-purple-100 rounded-2xl",children:e.jsx(fe,{className:"w-6 h-6 text-purple-600"})})]})})}),e.jsx(f,{className:"glass hover:glass-strong transition-smooth hover-lift border-white/20",children:e.jsx(j,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Today's Transactions"}),e.jsx("h3",{className:"text-3xl font-black mt-2",children:v.todayTransactions})]}),e.jsx("div",{className:"p-3 bg-orange-100 rounded-2xl",children:e.jsx(ie,{className:"w-6 h-6 text-orange-600"})})]})})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx(U,{placeholder:"Search by email, name, or balance...",value:d,onChange:s=>J(s.target.value),className:"pl-12 h-14 rounded-2xl glass-strong"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:C.map(s=>e.jsxs(f,{className:"glass hover:glass-strong transition-smooth hover-lift cursor-pointer group border-white/20",onClick:()=>L(s),children:[e.jsxs(oe,{className:"flex flex-row items-center justify-between pb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(R,{className:"h-12 w-12 ring-2 ring-primary/20",children:[e.jsx(I,{src:s.user_avatar}),e.jsx(q,{className:"bg-gradient-to-br from-primary to-green-600 text-white font-bold",children:B(s.user_name)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h4",{className:"font-heading font-bold text-sm truncate",children:s.user_name||"Unknown User"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.user_email})]})]}),e.jsx(P,{className:"w-5 h-5 text-primary opacity-0 group-hover:opacity-100 transition-opacity"})]}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Balance"}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:"text-2xl font-black text-primary",children:s.currency}),e.jsx("h3",{className:"text-3xl font-black",children:s.balance.toLocaleString()})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Transactions"}),e.jsx("p",{className:"font-bold mt-1",children:s.transaction_count||0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Last Activity"}),e.jsx("p",{className:"font-bold mt-1 text-xs",children:s.last_activity?V(new Date(s.last_activity),"MMM dd"):"Never"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",onClick:t=>t.stopPropagation(),children:[e.jsxs(m,{size:"sm",variant:"outline",className:"flex-1 gap-1 hover-glow-primary",onClick:()=>F(s,"credit"),children:[e.jsx(je,{className:"w-3 h-3"}),"Credit"]}),e.jsxs(m,{size:"sm",variant:"outline",className:"flex-1 gap-1",onClick:()=>F(s,"debit"),children:[e.jsx(pe,{className:"w-3 h-3"}),"Debit"]}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>L(s),children:e.jsx(ve,{className:"w-4 h-4"})})]})]})]},s.id))}),C.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(P,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No wallets found"})]}),e.jsx(H,{open:Z,onOpenChange:W,children:e.jsxs(z,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsx(O,{children:e.jsxs(K,{className:"flex items-center gap-3",children:[e.jsxs(R,{children:[e.jsx(I,{src:a?.user_avatar}),e.jsx(q,{children:B(a?.user_name)})]}),e.jsxs("div",{children:[e.jsxs("div",{children:[a?.user_name,"'s Wallet"]}),e.jsx("div",{className:"text-sm font-normal text-muted-foreground",children:a?.user_email})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-muted rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Current Balance:"}),e.jsxs("span",{className:"text-2xl font-black text-primary",children:[a?.currency," ",a?.balance.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold mb-3",children:"Transaction History"}),e.jsx("div",{className:"space-y-2",children:X.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${s.type==="credit"?"bg-green-100":"bg-blue-100"}`,children:s.type==="credit"?e.jsx(Ne,{className:"w-4 h-4 text-green-600"}):e.jsx(be,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-sm",children:s.description}),e.jsx("p",{className:"text-xs text-muted-foreground",children:V(new Date(s.created_at),"MMM dd, yyyy â€¢ h:mm a")})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:`font-black ${s.type==="credit"?"text-green-600":"text-blue-600"}`,children:[s.type==="credit"?"+":"-"," ",s.amount.toLocaleString()]}),e.jsx(de,{variant:"outline",className:"text-xs",children:s.status})]})]},s.id))})]})]})]})}),e.jsx(H,{open:ee,onOpenChange:p,children:e.jsxs(z,{children:[e.jsxs(O,{children:[e.jsxs(K,{children:[i==="credit"?"Credit":"Debit"," Wallet"]}),e.jsxs(me,{children:[i==="credit"?"Add funds to":"Remove funds from"," ",a?.user_name,"'s wallet"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx($,{htmlFor:"amount",children:"Amount (KES)"}),e.jsx(U,{id:"amount",type:"number",placeholder:"0.00",value:x,onChange:s=>D(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"reason",children:"Reason"}),e.jsx(he,{id:"reason",placeholder:"Enter reason for this adjustment...",value:h,onChange:s=>T(s.target.value),rows:3})]}),e.jsxs("div",{className:"p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Current Balance:"}),e.jsxs("p",{className:"text-lg font-black",children:[a?.currency," ",a?.balance.toLocaleString()]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"New Balance:"}),e.jsxs("p",{className:`text-lg font-black ${i==="credit"?"text-green-600":"text-blue-600"}`,children:[a?.currency," ",(a?.balance+(i==="credit"?1:-1)*parseFloat(x||"0")).toLocaleString()]})]})]})]}),e.jsxs(xe,{children:[e.jsx(m,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(m,{onClick:re,disabled:k,className:i==="credit"?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700",children:k?"Processing...":`${i==="credit"?"Credit":"Debit"} Wallet`})]})]})})]})}export{Ue as default};
